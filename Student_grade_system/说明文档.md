# 学生成绩管理系统 - 项目说明文档

## 一、项目规划

### 1.1 项目背景与目标
本项目旨在为「Way To Future」体系（橡心国际）开发一套基于Web的学生成绩管理系统。系统需支持学生信息管理、成绩录入、查询统计、成绩单生成等核心功能，并适配Mac mini M4内网部署环境。

### 1.2 核心功能模块
1.  **基础数据管理**：学生、班级、年级、科目、教师信息的增删改查。
2.  **考试管理**：
    *   考试场次管理（学年、学期、状态）。
    *   试卷模板管理（关联科目、年级、设定题目结构）。
    *   试卷管理（关联考试、模板、分配出卷/阅卷教师）。
3.  **成绩管理**：
    *   在线阅卷登分（支持按题录入）。
    *   批量成绩更新。
    *   成绩统计分析（总分、排名、得分率）。
4.  **报表与输出**：
    *   个人成绩单生成（PDF导出，包含雷达图分析）。
    *   班级/年级成绩统计报表。
5.  **高级功能**（规划中）：
    *   Excel数据批量导入/导出。
    *   LLM智能分析与建议生成。

### 1.3 技术架构
*   **前端**：Bootstrap 5, Jinja2 Templates, jQuery, SweetAlert2.
*   **后端**：Python 3.9+, Flask, SQLAlchemy.
*   **数据库**：SQLite (开发/测试), MySQL 8.0+ (生产).
*   **部署**：Docker / Shell Script (Mac mini M4, macOS/Linux).

---

## 二、实施方案

### 2.1 开发规范
*   **环境**：Mac系统，Trae编辑器。
*   **代码规范**：所有函数需添加功能描述、参数说明、返回值注释。
*   **流程**：遵循 MCP Sequential Thinking，严格执行 TodoList。

### 2.2 数据模型设计
核心实体包括：
*   `users` / `teachers`: 用户与权限管理。
*   `students`, `classes`, `grades`: 学生组织架构。
*   `subjects`: 学科定义。
*   `exam_sessions`: 考试批次（如"2025秋季期末"）。
*   `exam_templates`: 试卷结构定义（包含 `questions`）。
*   `exams`: 实际考试实例（关联 Session 和 Template）。
*   `scores`: 学生答题得分记录。
*   `report_cards`: 生成的成绩单记录。

### 2.3 接口设计
采用 **tRPC** 协议进行前后端类型安全通信，主要Router包括：
*   `auth`: 认证相关。
*   `students`: 学生管理。
*   `teachers`: 教师管理。
*   `exams`: 考试与试卷管理。
*   `scores`: 成绩录入与查询。

---

## 三、进度记录

### 3.1 已完成事项
*   **数据库设计**：完成所有核心表结构设计与迁移（Drizzle Schema）。
*   **后端基础**：搭建Express + tRPC服务器，实现JWT认证。
*   **前端框架**：完成Dashboard布局，集成UI组件库。
*   **基础管理功能**：
    *   [x] 学生、班级、科目、试卷模板的CRUD。
    *   [x] 教师管理（添加、列表、权限控制）。
*   **考试业务流程**：
    *   [x] 考试场次创建与管理。
    *   [x] 试卷创建与关联（支持从模板复制）。
    *   [x] 题目管理（支持按模块、知识点设定）。
*   **成绩系统**：
    *   [x] 成绩录入界面（表格化、实时计算，已优化iPad端体验）。
    *   [x] 成绩录入体验优化（阅卷权限控制、科目筛选、成绩回显）。
    *   [x] 成绩单PDF生成逻辑（集成 ReportLab 实现A4双面输出）。
*   **权限控制**：
    *   [x] Python简化版实现用户认证 (User Model, Login/Logout, @login_required)。
    *   [x] 细粒度权限控制（阅卷老师仅见负责试卷）。
*   **部署准备**：
    *   [x] 完成Mac mini M4部署脚本 (`deploy.sh`, `start.sh`)。
    *   [x] 修复服务热重启问题（确保旧进程彻底清理）。
    *   [x] 编写 `DEPLOYMENT.md`。
    *   [x] **项目结构治理**：清理冗余代码与临时文件，统一技术栈为 Python/Flask，确保 SSOT。
    *   [x] 实现从图片OCR信息生成Excel并导入数据库
    *   [x] 实现数据管理中心：支持考试场次、试卷模板、考生信息、评分记录的 Excel 全量导入/导出（共8个功能点）。
    *   [x] 执行系统数据清理：保留考试场次配置，清除旧测试数据（试卷、考生、评分）。
    *   [x] 重新导入全量试卷模版：覆盖 WTF学术测评、MAP、2025秋季WTF 三大类考卷。

### 3.2 待办事项 (ToDo List)
#### 优先级：高
1.  **Excel导入功能**：
    *   [x] 实现Excel文件解析与数据映射（试卷导入）。
    *   [x] 实现Excel批量导入学生/成绩。
2.  *   **报表系统完善**：
    *   [x] 完善 Python 版各类统计报表（实现场次统计、分数段分布、题目正确率分析）。

#### 优先级：中
1.  **LLM集成**：
    *   [ ] 集成LLM API进行学生成绩智能分析。
    *   [ ] 自动生成学习建议。
2.  **前端细节**：
    *   [ ] 优化移动端适配。
    *   [ ] 添加更多数据可视化图表。

### 3.4 CVM 部署指南 (CodeBuddy 官方方案)
本方案延续 CodeBuddy 的部署方式，使用 `start_student_system.sh` 脚本在 8083 端口运行。

1.  **部署步骤**：
    *   确保代码已同步至 `/opt/Way To Future考试管理系统/Student_grade_system`。
    *   执行启动脚本：
        ```bash
        cd "/opt/Way To Future考试管理系统/Student_grade_system"
        chmod +x start_student_system.sh
        ./start_student_system.sh
        ```

2.  **管理说明**：
    *   脚本会自动处理依赖 (requirements.txt)。
    *   应用运行在 **8083** 端口 (http://101.35.149.123:8083)。
    *   日志文件：`student_system.log`。

### 3.5 最近更新
*   **2026-01-02**: 
    *   完成数据清理：清除旧试卷、考生、评分数据，保留考试场次配置。
    *   完成试卷模版重新导入：
        *   导入源文件：`WTF学术测评考卷登记表.xlsx`, `2025秋季第一学期WTF考卷登记表4.0.xlsx`, `MAP登记表.xlsx`。
        *   覆盖所有4个现有考试场次。
        *   优化试卷命名规则，移除场次前缀（如“AMC8”）。
        *   当前系统试卷总数：120份。
    *   完成考生信息及报名导入：
        *   数据源：`registration_data_ocr.xlsx`。
        *   自动创建缺失的学校和考生档案（自动生成 student_id）。
        *   根据报名表自动关联考试场次和对应试卷（新课标/朗文/MAP等）。
        *   成功导入考生26名，完成考试注册79人次。
    *   完成考生信息及报名手动补全（修复OCR数据缺失问题）：
        *   针对用户提供的4张图片表格（1.4/1.11 上下午场），手动编写脚本全量录入数据。
        *   录入考生共计 61 人次（去重后系统总考生数 71 人）。
        *   自动关联考试科目（小托福、袋鼠数学、MAP、校内学科等）。
        *   修复了“英语新课标”在 G4/G6 的映射（G4->牛津, G6->先锋）。
        *   记录了部分科目缺失模版的警告（如 G3英语新课标, G6朗文英语）。
    *   考生管理：
        *   列表页增加“报考科目”列，直观显示每位考生的已报名考试。
        *   优化数据展示，修复“列表显示不完整”的用户体验问题（实为信息维度缺失）。
    *   考生管理优化 (2026-01-02 晚):
        *   **UI修复**: 考生列表页新增“报考科目”列，修复数据展示不全问题。
        *   **数据清洗**: 合并因OCR识别错误导致的重复考生数据（如“黄昱珩” Grade 4/6 合并），确保系统人数（71人）与用户提供名单完全一致。
        *   **体验优化**: 修复性别默认显示“女”的问题，未知性别现在显示为“未知”。
    *   数据管理优化 (2026-01-02):
        *   **功能实现**: 新增“一键全量导出备份”功能，支持将考试场次、试卷模板、考生信息、评分记录导出为多Sheet Excel文件，确保数据安全。
        *   **Bug修复**: 修复“导出考生信息”功能因关联字段访问错误导致的报错。
        *   **稳定性**: 优化所有单项导出功能的错误处理机制，防止因数据缺失导致的系统崩溃。
        *   **导出功能增强**: 
            *   “导出试卷模板”升级：新增“题目明细”Sheet，完整导出每份试卷的题号、模块、知识点、分值等信息。
            *   “导出考生信息”升级：新增“报考详情”列，包含每位考生参加的考试场次及对应试卷名称。
            *   **一致性**: 确保单项导出功能与一键备份功能逻辑一致，数据完整。
    *   **项目治理 (2026-01-02)**:
        *   **代码清理**: 移除冗余的调试脚本、临时文件和废弃的 HTML 模板。
        *   **结构优化**: 将工具脚本归档至 `scripts/` 目录，测试脚本归档至 `tests/` 目录。
        *   **日志净化**: 移除生产环境中的调试输出 (DEBUG Print)。
        *   **发布准备**: 清理根目录冗余文件，删除 `__pycache__` 及旧日志，验证系统全量功能，确保达到发布标准。
*   **2025-12-28**: 完成Excel导入功能（试卷、学生、成绩）及统计报表Excel导出功能。
*   **2025-12-27**: 初始化文档，整理现有项目状态。确认系统已完成基础CRUD及核心考试流程，正处于功能完善与部署验证阶段。
