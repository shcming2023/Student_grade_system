{% extends "base.html" %}

{% block title %}考生管理 - 橡心国际WTF活动管理平台{% endblock %}

{% block content %}
    <div class="row mb-4">
        <div class="col-md-6">
            <h2><i class="fas fa-user-graduate me-2 text-wtf"></i>考生管理</h2>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-wtf" onclick="openCreateModal()">
                <i class="fas fa-plus me-2"></i>新建考生
            </button>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0 p-md-3">
            <!-- Desktop Table -->
            <div class="table-responsive d-none d-md-block">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="display:none;">学号</th>
                            <th>姓名</th>
                            <th>性别</th>
                            <th>年级</th>
                            <th>学校</th>
                            <th>报考科目</th>
                            <th style="display:none;">班级</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in students %}
                        <tr>
                            <td style="display:none;">{{ student.student_id }}</td>
                            <td>{{ student.name }}</td>
                            <td>
                                {% if student.gender == 'M' %}
                                <span class="badge bg-primary">男</span>
                                {% elif student.gender == 'F' %}
                                <span class="badge bg-danger">女</span>
                                {% else %}
                                <span class="badge bg-secondary">未知</span>
                                {% endif %}
                            </td>
                            <td>{{ student.grade_level }}</td>
                            <td>{{ student.school.name if student.school else '未知' }}</td>
                            <td>
                                {% for reg in student.registrations %}
                                <span class="badge bg-info text-dark mb-1">{{ reg.exam_template.name }}</span>
                                {% endfor %}
                            </td>
                            <td style="display:none;">{{ student.class_name or '-' }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-success me-1" onclick="exportStudentPDF({{ student.id }}, '{{ student.name }}')" title="导出所有成绩单">
                                    <i class="fas fa-file-pdf"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick='openEditModal({{ student.to_dict()|tojson }})'>
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteStudent({{ student.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center py-4 text-muted">暂无考生数据</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Mobile Cards -->
            <div class="d-md-none p-3">
                {% for student in students %}
                <div class="card mb-3 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h5 class="card-title fw-bold mb-1">{{ student.name }}</h5>
                                <div class="text-muted small">{{ student.school.name if student.school else '未知' }} | {{ student.grade_level }}</div>
                            </div>
                            <div>
                                {% if student.gender == 'M' %}
                                <span class="badge bg-primary">男</span>
                                {% elif student.gender == 'F' %}
                                <span class="badge bg-danger">女</span>
                                {% else %}
                                <span class="badge bg-secondary">未知</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            {% for reg in student.registrations %}
                            <span class="badge bg-info text-dark me-1 mb-1">{{ reg.exam_template.name }}</span>
                            {% endfor %}
                        </div>

                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-success flex-grow-1 py-2" onclick="exportStudentPDF({{ student.id }}, '{{ student.name }}')">
                                <i class="fas fa-file-pdf"></i> 导出
                            </button>
                            <button class="btn btn-sm btn-outline-primary flex-grow-1 py-2" onclick='openEditModal({{ student.to_dict()|tojson }})'>
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="btn btn-sm btn-outline-danger flex-grow-1 py-2" onclick="deleteStudent({{ student.id }})">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-4 text-muted">暂无考生数据</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- 模态框 -->
    <div class="modal fade" id="studentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">新建考生</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="studentForm">
                        <input type="hidden" id="studentDbId">
                        <div class="mb-3" style="display:none;">
                            <label class="form-label">学号 (选填)</label>
                            <input type="text" class="form-control" id="studentId">
                            <div class="form-text">如不填写，系统将自动生成</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">姓名</label>
                            <input type="text" class="form-control" id="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">性别</label>
                            <select class="form-select" id="gender" required>
                                <option value="M">男</option>
                                <option value="F">女</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">年级</label>
                            <input type="text" class="form-control" id="gradeLevel" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">学校</label>
                            <input class="form-control" list="schoolOptions" id="schoolName" required placeholder="选择或输入学校名称">
                            <datalist id="schoolOptions">
                                {% for school in schools %}
                                <option value="{{ school.name }}">
                                {% endfor %}
                            </datalist>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">班级 (选填)</label>
                            <input type="text" class="form-control" id="className">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">考试报名 (多选)</label>
                            <div id="registrationOptions" class="border p-2 bg-light rounded" style="max-height: 250px; overflow-y: auto;">
                                <div class="text-muted small">正在加载...</div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-wtf" onclick="saveStudent()">保存</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    let modal;
    let allRegistrationOptions = [];
    
    document.addEventListener('DOMContentLoaded', function() {
        modal = new bootstrap.Modal(document.getElementById('studentModal'));
        fetchRegistrationOptions();
    });

    function fetchRegistrationOptions() {
        fetch('/api/students/registration-options')
            .then(res => res.json())
            .then(data => {
                allRegistrationOptions = data;
            })
            .catch(err => console.error('Error fetching reg options:', err));
    }

    function renderRegistrationOptions(currentRegs = []) {
        const container = document.getElementById('registrationOptions');
        if (!allRegistrationOptions.length) {
            container.innerHTML = '<div class="text-muted small">无可用考试场次</div>';
            return;
        }

        const currentSet = new Set(currentRegs.map(r => `${r.session_id}-${r.template_id}`));

        let html = '';
        allRegistrationOptions.forEach(session => {
            html += `<div class="mb-2">`;
            html += `<div class="fw-bold">${session.name}</div>`;
            html += `<div class="ms-3">`;
            
            if (session.templates.length === 0) {
                 html += `<span class="text-muted small">无试卷</span>`;
            } else {
                session.templates.forEach(tpl => {
                    const key = `${session.id}-${tpl.id}`;
                    const checked = currentSet.has(key) ? 'checked' : '';
                    html += `
                        <div class="form-check">
                            <input class="form-check-input reg-checkbox" type="checkbox" 
                                   value="${tpl.id}" data-session="${session.id}" id="reg-${key}" ${checked}>
                            <label class="form-check-label" for="reg-${key}">
                                ${tpl.name} <span class="text-muted small">(${tpl.subject_name})</span>
                            </label>
                        </div>
                    `;
                });
            }
            html += `</div></div>`;
        });
        container.innerHTML = html;
    }

    function openCreateModal() {
        document.getElementById('modalTitle').textContent = '新建考生';
        document.getElementById('studentForm').reset();
        document.getElementById('studentDbId').value = '';
        renderRegistrationOptions([]);
        modal.show();
    }

    function openEditModal(studentBasic) {
        document.getElementById('modalTitle').textContent = '编辑考生';
        document.getElementById('studentDbId').value = studentBasic.id;
        document.getElementById('studentId').value = studentBasic.student_id;
        document.getElementById('name').value = studentBasic.name;
        document.getElementById('gender').value = studentBasic.gender;
        document.getElementById('gradeLevel').value = studentBasic.grade_level;
        
        // 如果后端返回的 student 对象里包含 school_name 或者 school 对象
        document.getElementById('schoolName').value = studentBasic.school_name || (studentBasic.school ? studentBasic.school.name : ''); 
        
        document.getElementById('className').value = studentBasic.class_name;
        modal.show();
        
        document.getElementById('registrationOptions').innerHTML = '<div class="text-muted small">加载报名信息...</div>';

        fetch(`/api/students/${studentBasic.id}`)
            .then(res => res.json())
            .then(data => {
                renderRegistrationOptions(data.registrations);
            })
            .catch(err => {
                console.error(err);
                document.getElementById('registrationOptions').innerHTML = '<div class="text-danger small">加载失败</div>';
            });
    }

    function saveStudent() {
        const id = document.getElementById('studentDbId').value;
        
        // Collect registrations
        const regMap = {}; 
        document.querySelectorAll('.reg-checkbox:checked').forEach(cb => {
            const sId = cb.getAttribute('data-session');
            const tId = cb.value;
            if (!regMap[sId]) regMap[sId] = [];
            regMap[sId].push(tId);
        });

        const registrations = Object.keys(regMap).map(sId => ({
            session_id: sId,
            template_ids: regMap[sId]
        }));

        const data = {
            student_id: document.getElementById('studentId').value,
            name: document.getElementById('name').value,
            gender: document.getElementById('gender').value,
            grade_level: document.getElementById('gradeLevel').value,
            school_name: document.getElementById('schoolName').value,
            class_name: document.getElementById('className').value,
            registrations: registrations
        };

        const url = id ? `/api/students/${id}` : '/api/students/create';
        const method = id ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            return response.text().then(text => {
                try {
                    return JSON.parse(text);
                } catch (e) {
                    console.error("Non-JSON response received:", text);
                    throw new Error("Server returned invalid response format");
                }
            });
        })
        .then(result => {
            if (result.success) {
                Swal.fire('成功', result.message, 'success').then(() => {
                    location.reload();
                });
            } else {
                Swal.fire('错误', result.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire('错误', '系统错误，请重试。详情请查看控制台。', 'error');
        });
    }

    function exportStudentPDF(studentId, studentName) {
        Swal.fire({
            title: '正在生成成绩单...',
            text: '请稍候，这可能需要几秒钟',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        fetch(`/api/export/pdf/student/${studentId}`)
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.message || '导出失败');
                    });
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${studentName}_ReportCards.zip`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                Swal.close();
            })
            .catch(error => {
                Swal.fire('导出失败', error.message, 'error');
            });
    }


    
    function deleteStudent(id) {
        Swal.fire({
            title: '确定删除?',
            text: "此操作无法撤销！",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '确定删除',
            cancelButtonText: '取消'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/api/students/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        Swal.fire('已删除', result.message, 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('错误', result.message, 'error');
                    }
                });
            }
        });
    }
</script>
{% endblock %}
