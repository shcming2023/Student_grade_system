# 《学生成绩管理系统》项目修订开发任务书

**版本**: 4.0
**接收方**: 技术开发部门
**签发人**: Manus AI (项目经理)
**日期**: 2026年1月2日
**核心目标**: 依据最新决策，以“稳定、安全、易用”为原则，完成项目上线前的最后冲刺开发。

---

## A. 安全与稳定性任务 (P0 - 最高优先级)

此部分任务为**上线前必须完成**的红线任务，旨在消除已知的数据安全和系统稳定性风险。

### A1: 封禁危险的初始化路由

- **任务描述**: 禁用 `/api/init-templates` 路由，防止在生产环境被误触导致数据清空。
- **验收标准**:
    1. 在生产模式下（通过环境变量 `FLASK_ENV='production'` 判断），访问该接口应返回 HTTP 403 Forbidden 或 404 Not Found。
    2. 在开发模式下，该接口功能应保持不变，以便于测试。
- **实现建议**: 在 `api_init_templates` 函数入口处增加环境判断逻辑。

### A2: 实现删除操作的保护机制

- **任务描述**: 为所有核心数据的删除操作增加前置依赖检查，防止产生“孤儿数据”。
- **验收标准**:
    1. **删除学生**: 若该学生存在任何“报考记录”，则删除失败，并向前台返回明确提示信息（如：“无法删除，请先移除该考生的所有报考记录”）。
    2. **删除考试场次**: 若该场次下有任何“试卷模板”或“报考记录”，则删除失败，并返回相应提示。
    3. **删除试卷模板**: 若该模板下有任何“报考记录”或已录入的“成绩”，则删除失败，并返回相应提示。
- **实现建议**: 在执行 `db.session.delete()` 之前，先查询关联表是否存在相关记录。

### A3: 为所有删除操作增加前端二次确认

- **任务描述**: 在用户点击删除按钮时，必须弹窗进行二次确认，防止误操作。
- **验收标准**:
    1. 在“考生管理”、“考试管理”、“试卷管理”等页面的所有删除按钮上，点击后会弹出 `SweetAlert2` 确认框。
    2. 弹窗提示应清晰，如：“您确定要删除 [XXX] 吗？此操作无法撤销。”
    3. 只有当用户点击“确认”后，才执行删除操作；点击“取消”则无任何事发生。
- **实现建议**: 修改所有调用删除API的前端JavaScript函数，在 `fetch` 请求前插入 `Swal.fire()` 调用。

---

## B. 功能调整与优化任务 (P1 - 高优先级)

此部分任务涉及根据用户决策对现有功能进行移除和强化。

### B1: 移除所有数据导入功能

- **任务描述**: 根据决策，彻底移除项目所有的数据批量导入功能，简化系统。
- **验收标准**:
    1. **后端**: 以下API路由必须被完全删除或注释掉：`/api/students/import`, `/api/templates/import`, `/data/import/exams`, `/data/import/templates`, `/data/import/students`, `/data/import/scores`。
    2. **前端**: 在 `data_management.html` 页面，所有与“数据导入”相关的卡片模块必须被移除。
    3. **前端**: 在 `wtf_students.html` 页面，“导入考生”按钮必须被移除。

### B2: 优化并扩展PDF批量导出功能

- **任务描述**: 优化现有PDF生成逻辑，并根据新需求扩展批量导出功能。
- **验收标准**:
    1. **容错性优化**: 批量生成PDF的逻辑必须能够处理单个文件生成失败的情况。如果某个学生的成绩单生成失败，应跳过该生，继续处理下一个，并将失败的学生姓名和原因记录在ZIP包内的一个 `error_log.txt` 文件中。
    2. **新增“按学员导出”**: 在“考生管理”页面，为每一行学生增加一个“导出全部成绩单”按钮。点击后，系统应生成一个包含该学生所有科目成绩单PDF的ZIP压缩包。
    3. **新增“按试卷导出”**: 在“试卷管理”页面，为每一行试卷模板增加一个“导出全部成绩单”按钮。点击后，系统应生成一个包含所有报考了该试卷的学生的成绩单PDF的ZIP压缩包。
    4. **新增“一键全量导出”**: 在“成绩单”或“数据管理”页面，提供一个“一键导出所有PDF成绩单”的按钮，点击后生成包含系统中所有成绩单的ZIP压缩包。
- **实现建议**: 
    - 后端需要新增3个API路由来分别处理这三种批量导出模式。
    - 前端需要在对应页面添加操作按钮和调用API的JavaScript逻辑。

### B3: 优化登分界面的交互体验

- **任务描述**: 提升成绩录入页面的操作流畅性和用户反馈。
- **验收标准**:
    1. **键盘导航**: 在成绩录入表单中，用户可以通过按 `Tab` 键，按预期的顺序（从上到下，从左到右）在各个分数输入框之间无缝切换焦点。
    2. **保存状态反馈**: 当用户修改分数后，输入框失去焦点时，系统会自动保存。在保存请求发出和成功返回时，界面右上角应有明确的状态提示（如：“保存中...”、“✓ 已保存”），提示出现后应在2-3秒内自动消失。

---

## C. 界面与交互优化任务 (P2 - 中优先级)

此部分任务旨在提升系统在不同设备上的整体使用体验。

### C1: 全面优化PC端与移动端界面交互

- **任务描述**: 针对PC和移动设备的使用场景，优化核心页面的布局和交互，确保在小屏幕上也有良好的可用性。
- **验收标准**:
    1. **表格响应式**: 在移动端视图下，所有包含多列表格的页面（如考生管理、试卷管理等），表格应能横向滚动，而不是挤压变形或溢出页面。
    2. **按钮与表单**: 在移动端，所有按钮和表单输入框应有足够大的点击区域，易于触摸操作。模态框（Modal）应能正常显示和滚动。
    3. **导航优化**: 移动端的汉堡菜单应能顺畅地展开和收起。PC端的侧边栏在内容区域滚动时应保持固定。
    4. **高频页面适配**: 重点确保“评分录入”和“成绩单查看”页面在移动端布局合理，无元素重叠或错位问题。
- **实现建议**: 
    - 主要通过修改CSS样式实现，利用Bootstrap 5的响应式工具类（如 `d-lg-none`, `table-responsive`）。
    - 可能需要为特定页面编写媒体查询（`@media`）来自定义小屏幕进行微调布局。


---

## D. 实施计划与时间安排

为确保项目能够按时、高质量地完成，建议按以下时间表推进开发工作：

### 第一阶段：安全加固 (Day 1-2)

**目标**: 完成所有P0级别的安全与稳定性任务，确保系统底层稳固。

| 任务编号 | 任务名称 | 预计工时 | 负责人 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| A1 | 封禁危险路由 | 0.5小时 | 后端工程师 | 简单的环境判断逻辑 |
| A2 | 删除保护机制 | 4小时 | 后端工程师 | 需要修改多个删除API |
| A3 | 前端删除确认 | 2小时 | 前端工程师 | 修改多个页面的JS代码 |

**里程碑**: 第2天结束时，所有删除操作必须有保护和确认机制，危险路由已被封禁。

### 第二阶段：功能调整 (Day 3-4)

**目标**: 完成功能的移除和扩展，确保核心业务流程完整。

| 任务编号 | 任务名称 | 预计工时 | 负责人 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| B1 | 移除导入功能 | 2小时 | 全栈工程师 | 删除代码和前端元素 |
| B2.1 | PDF容错优化 | 3小时 | 后端工程师 | 修改批量生成逻辑 |
| B2.2 | 按学员导出 | 4小时 | 全栈工程师 | 新增API和前端按钮 |
| B2.3 | 按试卷导出 | 4小时 | 全栈工程师 | 新增API和前端按钮 |
| B2.4 | 一键全量导出 | 3小时 | 全栈工程师 | 新增API和前端按钮 |
| B3 | 登分界面优化 | 3小时 | 前端工程师 | 键盘导航+保存反馈 |

**里程碑**: 第4天结束时，所有导入功能已被移除，三种PDF批量导出模式已实现并测试通过。

### 第三阶段：界面优化 (Day 5-6)

**目标**: 提升PC和移动端的用户体验，确保在各种设备上都能流畅使用。

| 任务编号 | 任务名称 | 预计工时 | 负责人 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| C1.1 | 表格响应式优化 | 4小时 | 前端工程师 | 修改CSS和HTML结构 |
| C1.2 | 按钮与表单适配 | 3小时 | 前端工程师 | 调整移动端点击区域 |
| C1.3 | 导航优化 | 2小时 | 前端工程师 | 修复移动端菜单问题 |
| C1.4 | 高频页面适配 | 4小时 | 前端工程师 | 重点优化登分和成绩单页面 |

**里程碑**: 第6天结束时，系统在主流移动设备（iOS/Android）和PC浏览器上均能正常、流畅地使用。

### 第四阶段：测试与验收 (Day 7)

**目标**: 全面测试所有修改，确保没有引入新的Bug。

- **单元测试**: 对所有修改过的API接口进行单元测试，确保逻辑正确。
- **集成测试**: 模拟真实用户操作流程，测试从登录到成绩录入、PDF导出的完整链路。
- **兼容性测试**: 在Chrome、Safari、Firefox、Edge等主流浏览器，以及iOS和Android移动设备上进行测试。
- **验收**: 由产品经理进行最终验收，确认所有任务的验收标准均已达成。

---

## E. 技术实施细节与注意事项

### E1: 删除保护机制的实现逻辑

以"删除学生"为例，实现代码应遵循以下模式：

```python
@app.route('/api/students/<int:student_id>', methods=['DELETE'])
@login_required
def delete_student(student_id):
    student = Student.query.get(student_id)
    if not student:
        return jsonify({'success': False, 'message': '学生不存在'}), 404
    
    # 检查是否存在关联的报考记录
    registration_count = ExamRegistration.query.filter_by(student_id=student_id).count()
    if registration_count > 0:
        return jsonify({
            'success': False, 
            'message': f'无法删除：该考生存在 {registration_count} 条报考记录，请先移除这些记录。'
        }), 400
    
    # 检查是否存在关联的成绩记录
    score_count = Score.query.filter_by(student_id=student_id).count()
    if score_count > 0:
        return jsonify({
            'success': False, 
            'message': f'无法删除：该考生存在 {score_count} 条成绩记录，请先移除这些记录。'
        }), 400
    
    # 如果没有关联数据，则允许删除
    db.session.delete(student)
    db.session.commit()
    return jsonify({'success': True, 'message': '学生删除成功'})
```

**注意事项**: 对"删除考试场次"和"删除试卷模板"的API，也应采用类似的逻辑。

### E2: PDF批量导出的容错实现

在批量生成PDF的循环中，应使用 `try...except` 包裹单个文件的生成逻辑，并记录失败信息：

```python
@app.route('/api/pdf/batch-export-by-student/<int:student_id>', methods=['GET'])
@login_required
def batch_export_by_student(student_id):
    student = Student.query.get(student_id)
    if not student:
        return jsonify({'error': 'Student not found'}), 404
    
    zip_buffer = io.BytesIO()
    error_log = []
    
    with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zip_file:
        # 获取该学生的所有报考记录
        registrations = ExamRegistration.query.filter_by(student_id=student_id).all()
        
        for reg in registrations:
            try:
                pdf_buffer = generate_report_card_pdf(
                    student_id=student_id, 
                    exam_session_id=reg.exam_session_id, 
                    template_id=reg.exam_template_id
                )
                if pdf_buffer:
                    template = ExamTemplate.query.get(reg.exam_template_id)
                    filename = f"{student.name}_{template.name}_成绩单.pdf"
                    zip_file.writestr(filename, pdf_buffer.getvalue())
            except Exception as e:
                error_log.append(f"生成失败: {template.name} - 原因: {str(e)}")
        
        # 如果有失败记录，将其写入error_log.txt
        if error_log:
            error_content = "\n".join(error_log)
            zip_file.writestr("error_log.txt", error_content.encode('utf-8'))
    
    zip_buffer.seek(0)
    return send_file(
        zip_buffer,
        as_attachment=True,
        download_name=f'{student.name}_全部成绩单.zip',
        mimetype='application/zip'
    )
```

**注意事项**: "按试卷导出"和"一键全量导出"的实现逻辑类似，只是查询条件不同。

### E3: 登分界面键盘导航的实现

在 `score_entry_form.html` 的JavaScript中，动态生成输入框时，应为每个输入框设置正确的 `tabindex` 属性：

```javascript
questions.forEach((q, index) => {
    const inputHtml = `
        <input type="number" 
               class="form-control score-input" 
               id="score-${q.id}" 
               data-question-id="${q.id}" 
               max="${q.score}" 
               step="0.5" 
               tabindex="${index + 1}"
               placeholder="0-${q.score}">
    `;
    // ... 其余渲染逻辑
});
```

同时，在输入框的 `blur` 事件中，增加保存状态提示：

```javascript
document.querySelectorAll('.score-input').forEach(input => {
    input.addEventListener('blur', function() {
        showSavingIndicator(); // 显示"保存中..."
        saveScore(this.dataset.questionId, this.value)
            .then(() => {
                showSavedIndicator(); // 显示"✓ 已保存"
            })
            .catch(() => {
                showErrorIndicator(); // 显示"保存失败"
            });
    });
});
```

---

## F. 验收标准总结

开发完成后，必须确保以下所有验收标准均已达成，方可进入生产部署：

1. ✅ 在生产环境下，访问 `/api/init-templates` 返回403或404错误。
2. ✅ 所有删除操作在有关联数据时会被拒绝，并返回明确的错误提示。
3. ✅ 所有删除按钮点击后会弹出二次确认对话框。
4. ✅ 所有数据导入相关的API和前端元素已被完全移除。
5. ✅ 批量生成PDF时，单个失败不会影响整体，且失败信息会记录在ZIP包内的error_log.txt中。
6. ✅ "按学员导出"、"按试卷导出"、"一键全量导出"三种PDF批量导出功能均已实现并可正常使用。
7. ✅ 登分界面可以通过Tab键顺畅切换输入框，且保存成功后有明确的视觉反馈。
8. ✅ 系统在主流PC浏览器和移动设备上均能正常、流畅地使用，无明显布局错乱或交互障碍。

---

## G. 后续迭代规划 (暂缓任务)

以下任务根据用户决策暂时不在本次开发范围内，但应在后续版本中考虑实现：

1. **雷达图功能**: 在成绩单PDF中增加六维能力雷达图，提升可视化效果。
2. **AI评语功能**: 将当前的规则生成评语升级为真正的AI生成（接入DeepSeek或OpenAI API），提供更个性化的学习建议。
3. **数据导入功能重构**: 如果未来业务需要，可以重新设计一个更健壮、更友好的导入功能，包括预校验、错误详情报告等。

---

**任务书签发完毕。请技术开发部门按照本文档的要求和时间表，有序推进开发工作。如有技术实施上的疑问，请及时与项目经理沟通。**
