{% extends "base.html" %}

{% block title %}试卷管理 - 橡心国际WTF活动管理平台{% endblock %}

{% block content %}
    <div class="row mb-4">
        <div class="col-md-6">
            <h2><i class="fas fa-file-signature me-2 text-wtf"></i>试卷管理</h2>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-wtf" onclick="openCreateModal()">
                <i class="fas fa-plus me-2"></i>新建试卷模板
            </button>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0 p-md-3">
            <div class="table-responsive d-none d-md-block">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>试卷名称</th>
                            <th>所属考试</th>
                            <th>科目</th>
                            <th>年级</th>
                            <th>出卷</th>
                            <th>阅卷</th>
                            <th>题目数量</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for template in templates %}
                        <tr>
                            <td>{{ template.id }}</td>
                            <td>{{ template.name }}</td>
                            <td>{{ template.sessions|map(attribute='name')|join(', ') if template.sessions else '-' }}</td>
                            <td>{{ template.subject.name }}</td>
                            <td>{{ template.grade_level }}</td>
                            <td>{{ template.creator.username if template.creator else '-' }}</td>
                            <td>{{ template.grader.username if template.grader else '-' }}</td>
                            <td><span class="badge bg-info">{{ template.total_questions }}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick='openQuestionsModal({{ template.to_dict()|tojson }})'>
                                    <i class="fas fa-list"></i> 题目
                                </button>
                                <button class="btn btn-sm btn-outline-secondary me-1" onclick='openEditModal({{ template.to_dict()|tojson }})'>
                                    <i class="fas fa-edit"></i> 编辑
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTemplate({{ template.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Mobile Cards -->
            <div class="d-md-none p-3">
                {% for template in templates %}
                <div class="card mb-3 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h5 class="card-title fw-bold mb-1">{{ template.name }}</h5>
                                <div class="text-muted small">
                                    <span class="badge bg-light text-dark border me-1">{{ template.subject.name }}</span>
                                    <span class="badge bg-light text-dark border me-1">{{ template.grade_level }}</span>
                                    <span class="badge bg-info text-dark">{{ template.total_questions }} 题</span>
                                </div>
                            </div>
                            <div class="text-end">
                                <span class="text-muted small">#{{ template.id }}</span>
                            </div>
                        </div>
                        
                        <div class="mb-2 text-muted small">
                            <i class="fas fa-calendar-alt me-1"></i> {{ template.sessions|map(attribute='name')|join(', ') if template.sessions else '未关联考试' }}
                        </div>

                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-sm btn-outline-primary flex-grow-1" onclick='openQuestionsModal({{ template.to_dict()|tojson }})'>
                                <i class="fas fa-list"></i> 题目
                            </button>
                            <button class="btn btn-sm btn-outline-secondary flex-grow-1" onclick='openEditModal({{ template.to_dict()|tojson }})'>
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="btn btn-sm btn-outline-danger flex-grow-1" onclick="deleteTemplate({{ template.id }})">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-4 text-muted">暂无试卷数据</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div class="modal fade" id="templateModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen-md-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">新建试卷模板</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="templateForm">
                        <input type="hidden" id="templateDbId">
                        <div class="mb-3">
                            <label class="form-label">试卷名称</label>
                            <input type="text" class="form-control" id="templateName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">所属考试 (支持多选)</label>
                            <select class="form-select" id="templateSession" multiple style="height: 150px;">
                                {% for session in sessions %}
                                <option value="{{ session.id }}">{{ session.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">科目</label>
                            <select class="form-select" id="templateSubject" required>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}">{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">适用年级</label>
                            <select class="form-select" id="templateGrade" required>
                                <option value="G1">G1</option>
                                <option value="G2">G2</option>
                                <option value="G3">G3</option>
                                <option value="G4">G4</option>
                                <option value="G5">G5</option>
                                <option value="G6">G6</option>
                                <option value="ALL">通用</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">出卷老师</label>
                                <select class="form-select" id="templateCreator">
                                    <option value="">-- 请选择 --</option>
                                    {% for teacher in teachers %}
                                    <option value="{{ teacher.id }}">{{ teacher.username }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">阅卷老师</label>
                                <select class="form-select" id="templateGrader">
                                    <option value="">-- 请选择 --</option>
                                    {% for teacher in teachers %}
                                    <option value="{{ teacher.id }}">{{ teacher.username }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveTemplate()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Questions Modal -->
    <div class="modal fade" id="questionsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-fullscreen-md-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="questionsModalTitle">管理题目</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <form id="addQuestionForm" class="row g-3">
                            <input type="hidden" id="currentTemplateId">
                            <input type="hidden" id="questionDbId">
                            <div class="col-md-2">
                                <input type="text" class="form-control" id="qNumber" placeholder="题号" required>
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="qModule" placeholder="模块">
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="qKnowledge" placeholder="知识点">
                            </div>
                            <div class="col-md-2">
                                <input type="number" step="0.5" class="form-control" id="qScore" placeholder="分值" required>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-success w-100" onclick="saveQuestion()">
                                    <i class="fas fa-save"></i> 保存
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>题号</th>
                                    <th>模块</th>
                                    <th>知识点</th>
                                    <th>分值</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="questionsTableBody">
                                <!-- Loaded via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    let templateModal;
    let questionsModal;
    
    document.addEventListener('DOMContentLoaded', function() {
        templateModal = new bootstrap.Modal(document.getElementById('templateModal'));
        questionsModal = new bootstrap.Modal(document.getElementById('questionsModal'));
    });


    function exportTemplatePDFs(templateId, templateName) {
        Swal.fire({
            title: '正在生成成绩单...',
            text: '请稍候，这可能需要几秒钟',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        fetch(`/api/export/pdf/template/${templateId}`)
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.message || '导出失败');
                    });
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${templateName}_ReportCards.zip`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                Swal.close();
            })
            .catch(error => {
                Swal.fire('导出失败', error.message, 'error');
            });
    }

    function openCreateModal() {
        document.getElementById('modalTitle').textContent = '新建试卷模板';
        document.getElementById('templateForm').reset();
        document.getElementById('templateDbId').value = '';
        
        // Default select all sessions
        const sessionSelect = document.getElementById('templateSession');
        for (let i = 0; i < sessionSelect.options.length; i++) {
            sessionSelect.options[i].selected = true;
        }
        
        templateModal.show();
    }

    function openEditModal(template) {
        document.getElementById('modalTitle').textContent = '编辑试卷模板';
        document.getElementById('templateDbId').value = template.id;
        document.getElementById('templateName').value = template.name;
        
        // Handle multi-select sessions
        const sessionSelect = document.getElementById('templateSession');
        // Clear previous selection
        for (let i = 0; i < sessionSelect.options.length; i++) {
            sessionSelect.options[i].selected = false;
        }
        // Select associated sessions
        if (template.session_ids && template.session_ids.length > 0) {
            for (let i = 0; i < sessionSelect.options.length; i++) {
                if (template.session_ids.includes(parseInt(sessionSelect.options[i].value))) {
                    sessionSelect.options[i].selected = true;
                }
            }
        } else if (template.exam_session_id) {
             // Fallback for old data
             for (let i = 0; i < sessionSelect.options.length; i++) {
                if (parseInt(sessionSelect.options[i].value) === template.exam_session_id) {
                    sessionSelect.options[i].selected = true;
                    break;
                }
            }
        }

        document.getElementById('templateSubject').value = template.subject_id;
        document.getElementById('templateGrade').value = template.grade_level;
        document.getElementById('templateCreator').value = template.creator_id || '';
        document.getElementById('templateGrader').value = template.grader_id || '';
        templateModal.show();
    }

    function saveTemplate() {
        const id = document.getElementById('templateDbId').value;
        
        // Get selected session IDs
        const sessionSelect = document.getElementById('templateSession');
        const selectedSessionIds = Array.from(sessionSelect.selectedOptions).map(option => parseInt(option.value));
        
        const data = {
            name: document.getElementById('templateName').value,
            session_ids: selectedSessionIds,
            subject_id: document.getElementById('templateSubject').value,
            grade_level: document.getElementById('templateGrade').value,
            creator_id: document.getElementById('templateCreator').value || null,
            grader_id: document.getElementById('templateGrader').value || null
        };
        
        const url = id ? `/api/exam_templates/${id}` : '/api/exam_templates';
        const method = id ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                templateModal.hide();
                Swal.fire('成功', result.message, 'success').then(() => {
                    location.reload();
                });
            } else {
                Swal.fire('错误', result.message, 'error');
            }
        });
    }

    function deleteTemplate(id) {
        Swal.fire({
            title: '确定删除?',
            text: "此操作无法撤销！",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '确定删除',
            cancelButtonText: '取消'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/api/exam_templates/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        Swal.fire('已删除', result.message, 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('错误', result.message, 'error');
                    }
                });
            }
        });
    }

    function openQuestionsModal(template) {
        document.getElementById('questionsModalTitle').textContent = `管理题目 - ${template.name}`;
        document.getElementById('currentTemplateId').value = template.id;
        document.getElementById('addQuestionForm').reset();
        loadQuestions(template.id);
        questionsModal.show();
    }

    function loadQuestions(templateId) {
        fetch(`/api/exam_templates/${templateId}/questions`)
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('questionsTableBody');
                tbody.innerHTML = '';
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">暂无题目</td></tr>';
                    return;
                }

                data.forEach(q => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${q.question_number}</td>
                        <td>${q.module || '-'}</td>
                        <td>${q.knowledge_point || '-'}</td>
                        <td>${q.score}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteQuestion(${q.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
    }

    function saveQuestion() {
        const templateId = document.getElementById('currentTemplateId').value;
        const data = {
            question_number: document.getElementById('qNumber').value,
            module: document.getElementById('qModule').value,
            knowledge_point: document.getElementById('qKnowledge').value,
            score: document.getElementById('qScore').value
        };

        if (!data.question_number || !data.score) {
            Swal.fire('提示', '请填写题号和分值', 'warning');
            return;
        }

        fetch(`/api/exam_templates/\${templateId}/questions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Clear inputs except numbers might be auto-incremented in real app, but here just clear
                document.getElementById('qNumber').value = '';
                document.getElementById('qModule').value = '';
                document.getElementById('qKnowledge').value = '';
                document.getElementById('qScore').value = '';
                loadQuestions(templateId);
                // Update total questions badge if needed, but easier to reload page or just ignore for now
            } else {
                Swal.fire('错误', result.message, 'error');
            }
        });
    }

    function deleteQuestion(questionId) {
        Swal.fire({
            title: '确定删除此题目吗？',
            text: "此操作无法撤销！",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '确定删除',
            cancelButtonText: '取消'
        }).then((result) => {
            if (result.isConfirmed) {
                const templateId = document.getElementById('currentTemplateId').value;
                fetch(`/api/questions/\${questionId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        loadQuestions(templateId);
                        Swal.fire('已删除', '题目已删除', 'success');
                    } else {
                        Swal.fire('错误', result.message, 'error');
                    }
                });
            }
        });
    }
</script>
{% endblock %}
