{% extends "base.html" %}

{% block title %}评分录入 - 选择试卷 - 橡心国际WTF活动管理平台{% endblock %}

{% block extra_css %}
<style>
    .hover-shadow:hover {
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
        transition: box-shadow .3s ease-in-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">首页</a></li>
                <li class="breadcrumb-item active" aria-current="page">评分录入</li>
            </ol>
        </nav>

        <div class="card shadow-sm">
            <div class="card-body">
                <h4 class="card-title mb-3"><i class="fas fa-file-alt text-primary me-2"></i>选择评分试卷</h4>
                <p class="text-muted">请选择一个试卷模板进行评分录入。系统会自动聚合使用该模板的所有考试场次。</p>
                
                <div id="loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">正在加载试卷模板...</p>
                </div>

                <div id="error-message" class="alert alert-danger d-none"></div>

                <div id="templates-container" class="row g-4 d-none">
                    <!-- 模板卡片将在这里动态渲染 -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetchTemplates();
    });

    function fetchTemplates() {
        fetch('/api/score-entry/templates')
            .then(response => response.json())
            .then(data => {
                const loading = document.getElementById('loading');
                const container = document.getElementById('templates-container');
                
                loading.classList.add('d-none');
                container.classList.remove('d-none');
                
                if (data.length === 0) {
                    container.innerHTML = '<div class="col-12 text-center text-muted">暂无可用试卷模板</div>';
                    return;
                }

                let html = '';
                data.forEach(template => {
                    html += `
                        <div class="col-md-6 col-lg-4">
                            <div class="card h-100 border-start border-4 border-primary hover-shadow">
                                <div class="card-body">
                                    <h5 class="card-title fw-bold">${template.name}</h5>
                                    <p class="card-text text-muted small mb-3">
                                        <i class="fas fa-calendar-check me-1"></i> 包含 ${template.session_count} 个场次
                                    </p>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <span class="badge bg-info text-dark">
                                            <i class="fas fa-users me-1"></i> ${template.student_count} 考生
                                        </span>
                                        <a href="/score-entry/list?template_name=${encodeURIComponent(template.name)}" 
                                           class="btn btn-primary btn-sm stretched-link">
                                            开始录入 <i class="fas fa-arrow-right ms-1"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loading').classList.add('d-none');
                const errorDiv = document.getElementById('error-message');
                errorDiv.textContent = '加载失败，请重试';
                errorDiv.classList.remove('d-none');
            });
    }
</script>
{% endblock %}
